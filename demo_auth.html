<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteflix - Demo Autentica√ß√£o</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .movie-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
    
    <!-- PouchDB -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    
    <!-- Configura√ß√µes -->
    <script src="data/remote_config.js"></script>
    <script src="data/auth_config.js"></script>
    <script src="data/auth_interceptor.js"></script>
</head>
<body>
    <div class="container">
        <h1>üé¨ Meteflix - Sistema de Autentica√ß√£o com PouchDB</h1>
        
        <!-- Status do usu√°rio -->
        <div id="userStatus" class="user-info">
            <h3>Status do Usu√°rio</h3>
            <div id="userInfo">Carregando...</div>
            <button onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
        </div>
        
        <!-- Registro -->
        <div class="section">
            <h3>üìù Registrar Novo Usu√°rio</h3>
            <div class="form-group">
                <label>Nome:</label>
                <input type="text" id="regName" placeholder="Seu nome completo">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="regEmail" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label>Senha:</label>
                <input type="password" id="regPassword" placeholder="M√≠nimo 6 caracteres">
            </div>
            <button onclick="register()">Registrar</button>
            <div id="regStatus" class="status" style="display: none;"></div>
        </div>
        
        <!-- Login -->
        <div class="section">
            <h3>üîê Fazer Login</h3>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label>Senha:</label>
                <input type="password" id="loginPassword" placeholder="Sua senha">
            </div>
            <button onclick="login()">Login</button>
            <div id="loginStatus" class="status" style="display: none;"></div>
        </div>
        
        <!-- Gerenciar Filmes -->
        <div class="section">
            <h3>üé• Gerenciar Filmes</h3>
            <div class="form-group">
                <label>T√≠tulo do Filme:</label>
                <input type="text" id="movieTitle" placeholder="Nome do filme">
            </div>
            <div class="form-group">
                <label>G√™nero:</label>
                <input type="text" id="movieGenre" placeholder="A√ß√£o, Drama, Com√©dia...">
            </div>
            <div class="form-group">
                <label>Ano:</label>
                <input type="text" id="movieYear" placeholder="2024">
            </div>
            <button onclick="addMovie()">Adicionar Filme</button>
            <button onclick="loadMyMovies()">Carregar Meus Filmes</button>
            <div id="movieStatus" class="status" style="display: none;"></div>
            <div id="movieList" class="movie-list" style="display: none;">
                <h4>Meus Filmes:</h4>
                <div id="movies"></div>
            </div>
        </div>
        
        <!-- Informa√ß√µes de Sincroniza√ß√£o -->
        <div class="section">
            <h3>üîÑ Status da Sincroniza√ß√£o</h3>
            <div id="syncStatus" class="info">
                Verificando configura√ß√£o de sincroniza√ß√£o...
            </div>
        </div>
        
        <!-- Debug e Informa√ß√µes do Banco -->
        <div class="section">
            <h3>üîß Debug e Informa√ß√µes</h3>
            <button onclick="showDatabaseInfo()">Mostrar Informa√ß√µes do Banco</button>
            <button onclick="forceCreateDefaultUsers()">üë• Criar Usu√°rios Padr√£o</button>
            <button onclick="clearAllData()">Limpar Todos os Dados</button>
            <div id="debugInfo" class="info" style="display: none;">
                <h4>Informa√ß√µes do Sistema:</h4>
                <div id="dbInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // Atualizar status do usu√°rio
        function updateUserStatus() {
            const userInfo = document.getElementById('userInfo');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (authManager.isLoggedIn()) {
                const user = authManager.getCurrentUser();
                userInfo.innerHTML = `
                    <strong>‚úÖ Logado como:</strong> ${user.name} (${user.email})<br>
                    <strong>ID:</strong> ${user.id}
                `;
                logoutBtn.style.display = 'inline-block';
            } else {
                userInfo.innerHTML = '‚ùå N√£o logado';
                logoutBtn.style.display = 'none';
            }
        }
        
        // Registrar usu√°rio
        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const status = document.getElementById('regStatus');
            
            // Valida√ß√£o de campos
            if (!name || !email || !password) {
                showStatus('regStatus', 'Preencha todos os campos', 'error');
                return;
            }
            
            // Valida√ß√£o de nome
            if (name.length < 2) {
                showStatus('regStatus', 'O nome deve ter pelo menos 2 caracteres', 'error');
                return;
            }
            
            // Valida√ß√£o de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('regStatus', 'Digite um email v√°lido', 'error');
                return;
            }
            
            // Valida√ß√£o de senha
            if (password.length < 6) {
                showStatus('regStatus', 'A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            showStatus('regStatus', 'Registrando usu√°rio...', 'info');
            
            try {
                // Verificar se authManager est√° dispon√≠vel
                if (typeof authManager === 'undefined') {
                    showStatus('regStatus', 'Erro: Sistema de autentica√ß√£o n√£o carregado', 'error');
                    return;
                }
                
                const result = await authManager.registerUser(email, password, name);
                
                if (result.success) {
                    showStatus('regStatus', 'Usu√°rio registrado com sucesso!', 'success');
                    
                    // Limpar campos
                    document.getElementById('regName').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                    
                    // Atualizar status do usu√°rio se necess√°rio
                    updateUserStatus();
                } else {
                    showStatus('regStatus', `Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro no registro:', error);
                showStatus('regStatus', `Erro interno: ${error.message}`, 'error');
            }
        }
        
        // Fazer login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const status = document.getElementById('loginStatus');
            
            // Valida√ß√£o de campos
            if (!email || !password) {
                showStatus('loginStatus', 'Preencha email e senha', 'error');
                return;
            }
            
            // Valida√ß√£o de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('loginStatus', 'Digite um email v√°lido', 'error');
                return;
            }
            
            // Valida√ß√£o de senha
            if (password.length < 6) {
                showStatus('loginStatus', 'A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            showStatus('loginStatus', 'Fazendo login...', 'info');
            
            try {
                // Verificar se authManager est√° dispon√≠vel
                if (typeof authManager === 'undefined') {
                    showStatus('loginStatus', 'Erro: Sistema de autentica√ß√£o n√£o carregado', 'error');
                    return;
                }
                
                const result = await authManager.login(email, password);
                
                if (result.success) {
                    showStatus('loginStatus', 'Login realizado com sucesso!', 'success');
                    updateUserStatus();
                    
                    // Limpar campos
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    // Verificar redirecionamento se necess√°rio
                    if (window.authInterceptor) {
                        window.authInterceptor.checkRedirectAfterLogin();
                    }
                } else {
                    showStatus('loginStatus', `Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showStatus('loginStatus', `Erro interno: ${error.message}`, 'error');
            }
        }
        
        // Logout
        function logout() {
            authManager.logout();
            updateUserStatus();
            showStatus('loginStatus', 'Logout realizado', 'info');
        }
        
        // Adicionar filme
        async function addMovie() {
            if (!authManager.isLoggedIn()) {
                showStatus('movieStatus', 'Voc√™ precisa estar logado para adicionar filmes', 'error');
                return;
            }
            
            const title = document.getElementById('movieTitle').value;
            const genre = document.getElementById('movieGenre').value;
            const year = document.getElementById('movieYear').value;
            
            if (!title) {
                showStatus('movieStatus', 'Digite o t√≠tulo do filme', 'error');
                return;
            }
            
            const movie = {
                title: title,
                genre: genre || 'N√£o informado',
                year: year || 'N√£o informado'
            };
            
            showStatus('movieStatus', 'Adicionando filme...', 'info');
            
            const result = await authManager.adicionarFilme(movie);
            
            if (result.success) {
                showStatus('movieStatus', 'Filme adicionado com sucesso!', 'success');
                // Limpar campos
                document.getElementById('movieTitle').value = '';
                document.getElementById('movieGenre').value = '';
                document.getElementById('movieYear').value = '';
                // Recarregar lista
                loadMyMovies();
            } else {
                showStatus('movieStatus', `Erro: ${result.error}`, 'error');
            }
        }
        
        // Carregar filmes do usu√°rio
        async function loadMyMovies() {
            if (!authManager.isLoggedIn()) {
                showStatus('movieStatus', 'Voc√™ precisa estar logado para ver seus filmes', 'error');
                return;
            }
            
            const result = await authManager.getMyMovies();
            const movieList = document.getElementById('movieList');
            const moviesDiv = document.getElementById('movies');
            
            if (result.success) {
                if (result.movies.length === 0) {
                    moviesDiv.innerHTML = '<p>Nenhum filme encontrado.</p>';
                } else {
                    moviesDiv.innerHTML = result.movies.map(movie => `
                        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                            <strong>${movie.title}</strong><br>
                            G√™nero: ${movie.genre}<br>
                            Ano: ${movie.year}<br>
                            <small>Adicionado em: ${new Date(movie.addedAt).toLocaleString()}</small>
                        </div>
                    `).join('');
                }
                movieList.style.display = 'block';
            } else {
                showStatus('movieStatus', `Erro ao carregar filmes: ${result.error}`, 'error');
            }
        }
        
        // Mostrar status
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
        }
        
        // Verificar status de sincroniza√ß√£o
        function checkSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            const config = REMOTE_CONFIG;
            
            if (!config.active || config.active === 'local') {
                syncStatus.innerHTML = `
                    <strong>üì± Modo Local:</strong> Os dados s√£o salvos apenas no navegador.<br>
                    <small>Para habilitar sincroniza√ß√£o, configure um servidor remoto em data/remote_config.js</small>
                `;
            } else {
                const urls = getRemoteURLs();
                syncStatus.innerHTML = `
                    <strong>üåê Sincroniza√ß√£o Ativa:</strong> ${config.active}<br>
                    <strong>Usu√°rios:</strong> ${urls.usersDB || 'N√£o configurado'}<br>
                    <strong>Filmes:</strong> ${urls.moviesDB || 'N√£o configurado'}
                `;
            }
        }
        
        // Mostrar informa√ß√µes do banco de dados
        async function showDatabaseInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const dbInfo = document.getElementById('dbInfo');
            
            try {
                const usersInfo = await authManager.usersDB.info();
                const moviesInfo = await authManager.moviesDB.info();
                
                // Buscar todos os usu√°rios
                const usersResult = await authManager.usersDB.allDocs({
                    include_docs: true,
                    startkey: 'user_',
                    endkey: 'user_\uffff'
                });
                
                // Buscar todos os filmes
                const moviesResult = await authManager.moviesDB.allDocs({
                    include_docs: true
                });
                
                dbInfo.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <strong>üìä Banco de Usu√°rios:</strong><br>
                        ‚Ä¢ Documentos: ${usersInfo.doc_count}<br>
                        ‚Ä¢ Tamanho: ${(usersInfo.data_size / 1024).toFixed(2)} KB<br>
                        ‚Ä¢ Usu√°rios cadastrados: ${usersResult.rows.length}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>üé¨ Banco de Filmes:</strong><br>
                        ‚Ä¢ Documentos: ${moviesInfo.doc_count}<br>
                        ‚Ä¢ Tamanho: ${(moviesInfo.data_size / 1024).toFixed(2)} KB<br>
                        ‚Ä¢ Filmes cadastrados: ${moviesResult.rows.length}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>üë• Usu√°rios Cadastrados:</strong><br>
                        ${usersResult.rows.length === 0 ? 'Nenhum usu√°rio cadastrado' : 
                          usersResult.rows.map(row => 
                            `‚Ä¢ ${row.doc.name} (${row.doc.email}) - ${new Date(row.doc.createdAt).toLocaleString()}`
                          ).join('<br>')
                        }
                    </div>
                    
                    <div>
                        <strong>üé• Filmes Cadastrados:</strong><br>
                        ${moviesResult.rows.length === 0 ? 'Nenhum filme cadastrado' : 
                          moviesResult.rows.map(row => 
                            `‚Ä¢ ${row.doc.title} (${row.doc.year}) - ${row.doc.genre}`
                          ).join('<br>')
                        }
                    </div>
                `;
                
                debugInfo.style.display = 'block';
                
            } catch (error) {
                dbInfo.innerHTML = `Erro ao carregar informa√ß√µes: ${error.message}`;
                debugInfo.style.display = 'block';
            }
        }
        
        // For√ßar cria√ß√£o de usu√°rios padr√£o
        async function forceCreateDefaultUsers() {
            try {
                showStatus('loginStatus', 'Criando usu√°rios padr√£o...', 'info');
                
                // Usu√°rios padr√£o
                const defaultUsers = [
                    {
                        name: "Administrador",
                        email: "admin@meteflix.com",
                        password: "admin123",
                        isAdmin: true,
                        createdAt: "2024-01-01T00:00:00.000Z"
                    },
                    {
                        name: "Cliente Demo",
                        email: "cliente@meteflix.com", 
                        password: "cliente123",
                        isAdmin: false,
                        createdAt: "2024-01-01T00:00:00.000Z"
                    }
                ];
                
                for (const userData of defaultUsers) {
                    // Verificar se usu√°rio j√° existe
                    const existingUser = await authManager.findUserByEmail(userData.email);
                    if (!existingUser) {
                        const hashedPassword = await authManager.hashPassword(userData.password);
                        
                        const user = {
                            _id: 'user_' + Date.now() + Math.random(),
                            email: userData.email,
                            password: hashedPassword,
                            name: userData.name,
                            isAdmin: userData.isAdmin,
                            createdAt: userData.createdAt,
                            isActive: true
                        };
                        
                        await authManager.usersDB.put(user);
                        console.log(`Usu√°rio criado: ${userData.name} (${userData.email})`);
                    } else {
                        console.log(`Usu√°rio j√° existe: ${userData.email}`);
                    }
                }
                
                showStatus('loginStatus', 'Usu√°rios padr√£o criados com sucesso!', 'success');
                showDatabaseInfo();
            } catch (error) {
                showStatus('loginStatus', `Erro ao criar usu√°rios padr√£o: ${error.message}`, 'error');
            }
        }
        
        // Limpar todos os dados
        async function clearAllData() {
            if (!confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                // Destruir e recriar bancos
                await authManager.usersDB.destroy();
                await authManager.moviesDB.destroy();
                
                // Recriar bancos
                authManager.usersDB = new PouchDB('meteflix-users');
                authManager.moviesDB = new PouchDB('meu-site-streaming');
                
                showStatus('loginStatus', 'Todos os dados foram limpos!', 'success');
                updateUserStatus();
                
                // Esconder informa√ß√µes de debug
                document.getElementById('debugInfo').style.display = 'none';
                
            } catch (error) {
                showStatus('loginStatus', `Erro ao limpar dados: ${error.message}`, 'error');
            }
        }
        
        // Verificar se o sistema est√° funcionando
        function checkSystemStatus() {
            const userInfo = document.getElementById('userInfo');
            
            // Verificar se PouchDB est√° carregado
            if (typeof PouchDB === 'undefined') {
                userInfo.innerHTML = '‚ùå Erro: PouchDB n√£o carregado';
                return false;
            }
            
            // Verificar se authManager est√° carregado
            if (typeof authManager === 'undefined') {
                userInfo.innerHTML = '‚ùå Erro: Sistema de autentica√ß√£o n√£o carregado';
                return false;
            }
            
            // Verificar se os bancos est√£o funcionando
            try {
                authManager.usersDB.info().then(() => {
                    console.log('Sistema funcionando corretamente');
                }).catch(error => {
                    console.error('Erro ao verificar banco de usu√°rios:', error);
                    userInfo.innerHTML = '‚ùå Erro: Banco de dados n√£o acess√≠vel';
                });
            } catch (error) {
                console.error('Erro ao verificar sistema:', error);
                userInfo.innerHTML = '‚ùå Erro: Sistema n√£o inicializado';
                return false;
            }
            
            return true;
        }
        
        // Inicializar p√°gina
        window.addEventListener('load', () => {
            // Verificar sistema primeiro
            if (checkSystemStatus()) {
                updateUserStatus();
                checkSyncStatus();
            }
        });
    </script>
</body>
</html>

